<Window x:Class="Test.DataGridDemo.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:i="http://schemas.microsoft.com/xaml/behaviors"
        xmlns:local="clr-namespace:Test.DataGridDemo"
        mc:Ignorable="d"
        d:DataContext="{d:DesignInstance Type=local:MainWindowViewModel,
                                         d:IsDesignTimeCreatable=True}"
        Title="MainWindow"
        Height="450"
        Width="800">
    <Window.Resources>
        <local:VisibilityConverterIfFalse x:Key="VisibilityConverterIfFalse" />
        <local:VisibilityConverterIfTrue x:Key="VisibilityConverterIfTrue" />
        <local:BoolConvertReverse x:Key="BoolConvertReverse" />

        <Style x:Key="OperationButtonStyle" TargetType="{x:Type Button}">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="Width" Value="32" />
            <Setter Property="Height" Value="22" />
            <Setter Property="Cursor" Value="Hand" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate>
                        <TextBlock x:Name="txt"
                                   Margin="{TemplateBinding Padding}"
                                   HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}"
                                   VerticalAlignment="{TemplateBinding VerticalContentAlignment}"
                                   Text="{Binding Content, RelativeSource={RelativeSource TemplatedParent}}"
                                   Foreground="Blue"
                                   FontSize="14" />
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="txt" Property="Foreground" Value="#077BCE" />
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="DataGridColumnHeaderStyle" TargetType="{x:Type DataGridColumnHeader}">
            <Setter Property="Background" Value="#F4F7FE" />
            <Setter Property="BorderBrush" Value="{x:Null}" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="VerticalContentAlignment" Value="Center" />
            <Setter Property="Height" Value="48" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="DataGridColumnHeader">
                        <Border Background="{TemplateBinding Background}">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                </Grid.ColumnDefinitions>
                                <TextBlock Margin="36,0,0,0"
                                           HorizontalAlignment="Left"
                                           VerticalAlignment="Center"
                                           Text="{Binding Content, RelativeSource={RelativeSource TemplatedParent}}"
                                           Foreground="Blue"
                                           FontSize="14" />
                            </Grid>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="DataGridCellStyle" TargetType="DataGridCell">
            <Setter Property="Height" Value="45" />
            <Setter Property="IsEditing" Value="{Binding RelativeSource={RelativeSource Self}, Path=DataContext.IsEditing, Mode=TwoWay}" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="DataGridCell">
                        <ContentPresenter Margin="36,0,0,0"
                                          VerticalAlignment="Center"
                                          HorizontalAlignment="Left" />
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="DataGridStyle" TargetType="DataGrid">
            <Setter Property="CellStyle" Value="{StaticResource DataGridCellStyle}" />
            <Setter Property="AutoGenerateColumns" Value="False" />
            <Setter Property="CanUserResizeColumns" Value="False" />
            <Setter Property="CanUserAddRows" Value="False" />
            <Setter Property="CanUserDeleteRows" Value="False" />
            <Setter Property="CanUserSortColumns" Value="False" />
            <Setter Property="CanUserReorderColumns" Value="False" />
            <Setter Property="HeadersVisibility" Value="Column" />
            <Setter Property="SelectionMode" Value="Single" />
            <Setter Property="SelectionUnit" Value="FullRow" />
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="BorderBrush" Value="Transparent" />
            <Setter Property="Foreground" Value="#0B1926" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="HorizontalGridLinesBrush" Value="#EDF0F2" />
            <Setter Property="VerticalGridLinesBrush" Value="{x:Null}" />
            <Setter Property="RowDetailsVisibilityMode" Value="Collapsed" />
            <Setter Property="ScrollViewer.CanContentScroll" Value="true" />
            <Setter Property="ScrollViewer.HorizontalScrollBarVisibility" Value="Disabled" />
            <Setter Property="ScrollViewer.VerticalScrollBarVisibility" Value="Auto" />
            <Setter Property="FontSize" Value="14" />
            <Setter Property="IsReadOnly" Value="False" />
            <Setter Property="ColumnHeaderStyle" Value="{StaticResource DataGridColumnHeaderStyle}" />
        </Style>
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition />
            <RowDefinition Height="auto" />
        </Grid.RowDefinitions>

        <DataGrid x:Name="dataGrid"
                  ItemsSource="{Binding Bookmarks}"
                  Style="{StaticResource DataGridStyle}"
                  PreparingCellForEdit="dataGrid_PreparingCellForEdit"
                  CellEditEnding="dataGrid_CellEditEnding"
                  PreviewKeyDown="dataGrid_PreviewKeyDown">
            <DataGrid.Columns>
                <DataGridTemplateColumn Width="2*" Header="书签名称">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <TextBlock Foreground="Blue"
                                       FontSize="14"
                                       Text="{Binding BookmarkName}"
                                       TextTrimming="CharacterEllipsis"
                                       ToolTip="{Binding BookmarkName}" />
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                    <DataGridTemplateColumn.CellEditingTemplate>
                        <DataTemplate>
                            <TextBox Foreground="Blue"
                                     Background="Red"
                                     FontSize="14"
                                     Width="200"
                                     Height="32"
                                     VerticalContentAlignment="Center"
                                     Text="{Binding BookmarkName, UpdateSourceTrigger=PropertyChanged}"
                                     LostFocus="TextBox_LostFocus" />
                        </DataTemplate>
                    </DataGridTemplateColumn.CellEditingTemplate>
                </DataGridTemplateColumn>
                <DataGridTemplateColumn Width="*" Header="操作">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <StackPanel Orientation="Horizontal">
                                <!--  Visibility="{Binding IsEditing, Converter={StaticResource VisibilityConverterIfTrue}}"  -->
                                <Button Visibility="{Binding IsEditing, Converter={StaticResource VisibilityConverterIfTrue}}"
                                        Command="{Binding DataContext.SaveOrUpdateCommand, RelativeSource={RelativeSource AncestorType={x:Type Window}, AncestorLevel=1, Mode=FindAncestor}}"
                                        CommandParameter="{Binding}"
                                        Content="保存"
                                        Style="{StaticResource OperationButtonStyle}" />
                                <!--  Visibility="{Binding IsEditing, Converter={StaticResource VisibilityConverterIfFalse}}"  -->
                                <Button Visibility="{Binding IsEditing, Converter={StaticResource VisibilityConverterIfFalse}}"
                                        Command="{Binding DataContext.EditCommand, RelativeSource={RelativeSource AncestorType={x:Type Window}, AncestorLevel=1, Mode=FindAncestor}}"
                                        CommandParameter="{Binding}"
                                        Content="编辑"
                                        Style="{StaticResource OperationButtonStyle}" />
                                <Button Margin="16,0,0,0"
                                        Command="{Binding DataContext.DeleteCommand, RelativeSource={RelativeSource AncestorType={x:Type Window}, AncestorLevel=1, Mode=FindAncestor}}"
                                        CommandParameter="{Binding}"
                                        Content="删除"
                                        Style="{StaticResource OperationButtonStyle}" />
                            </StackPanel>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>
            </DataGrid.Columns>
        </DataGrid>

        <Button Grid.Row="1"
                Width="100"
                Height="32"
                Margin="0,10"
                Content="新增"
                Command="{Binding AddCommand}" />
    </Grid>

    <i:Interaction.Triggers>
        <i:EventTrigger EventName="Loaded">
            <i:InvokeCommandAction Command="{Binding LoadedCommand}" CommandParameter="{Binding ElementName=dataGrid}" />
        </i:EventTrigger>
    </i:Interaction.Triggers>

</Window>
